
# Employee Authentication System with Invite Code Verification

## Overview
This authentication flow is based on **Invite Codes** generated by an admin. An employee cannot register without entering a valid invite code first. The registration process consists of multiple steps to ensure security and proper role assignment.

---

## ✅ Flow Overview
1. **Enter Invite Code**:
   - User enters the invite code.
   - System checks if the code exists and is not used.
   - If invalid or already used → Return error **"Invalid or Used Code"**.
2. **Enter Basic Info**:
   - First name, last name, and email.
   - Email must be unique.
   - Create a temporary registration session in Redis or MongoDB.
3. **Send OTP**:
   - Generate a 6-digit OTP and send it to the user's email.
4. **Verify OTP**:
   - User enters OTP.
   - If correct → Move to password setup.
   - If incorrect → Return error **"Invalid OTP"**, with resend option.
5. **Set Password**:
   - User sets a secure password.
   - Complete registration:
     - Save user in the database.
     - Assign department and permissions from the invite code.
     - Mark the invite code as **used**.
6. **Login and Redirect**:
   - Generate JWT token and redirect user to the dashboard according to their role.

---

## ✅ Business Logic

### Invite Code Validation
- If code does not exist → Error: **Invalid or Used Code**.
- If code is already used → Error: **Invalid or Used Code**.
- If code is valid and active → Proceed to next step.

### OTP Validation
- OTP must match the one sent to the user's email.
- Expire OTP after a certain time (e.g., 10 minutes).

### Final Registration
- Save user details.
- Link user with the department and permissions from the invite code.
- Update invite code status to:
  - `is_used = true`
  - `used_by = user._id`
  - `status = 'used'`.

---

## ✅ API Endpoints

### 1. **POST /auth/verify-invite-code**
**Request:**
```json
{
  "invite_code": "ABC123"
}
```
**Response (Success):**
```json
{
  "status": "valid",
  "message": "Invite code is valid"
}
```
**Response (Error):**
```json
{
  "status": "error",
  "message": "Invalid or Used Code"
}
```

---

### 2. **POST /auth/start-registration**
**Request:**
```json
{
  "invite_code": "ABC123",
  "first_name": "John",
  "last_name": "Doe",
  "email": "john@example.com"
}
```
**Response:**
```json
{
  "status": "pending_otp",
  "message": "OTP sent to email"
}
```

---

### 3. **POST /auth/verify-otp**
**Request:**
```json
{
  "otp": "123456"
}
```
**Response:**
```json
{
  "status": "otp_verified",
  "message": "OTP is correct, proceed to set password"
}
```

---

### 4. **POST /auth/set-password**
**Request:**
```json
{
  "password": "securePass123",
  "confirm_password": "securePass123"
}
```
**Response:**
```json
{
  "status": "completed",
  "message": "Registration successful, redirect to dashboard"
}
```

---

## ✅ MongoDB Schema (Mongoose)

### Employee Schema
```js
const EmployeeSchema = new Schema({
  name: String,
  email: { type: String, unique: true },
  password: String,
  department_id: { type: Schema.Types.ObjectId, ref: 'Department' },
  permissions: { type: Object },
  created_at: { type: Date, default: Date.now }
});
```

### Invite Code Schema
```js
const InviteCodeSchema = new Schema({
  code: { type: String, unique: true },
  department_id: { type: Schema.Types.ObjectId, ref: 'Department' },
  permissions: { type: Object, required: true },
  is_used: { type: Boolean, default: false },
  used_by: { type: Schema.Types.ObjectId, ref: 'Employee' },
  status: { type: String, enum: ['active', 'used'], default: 'active' },
  created_at: { type: Date, default: Date.now }
});
```

---

## ✅ Additional Notes for Developer
- Use **Redis or MongoDB TTL Collections** for temporary registration sessions and OTP storage.
- OTP should expire after a certain time for security.
- After finalizing registration, delete the temporary session.
- Use **JWT tokens** for authentication after registration is completed.

---

## ✅ Flow Diagram (Text)
```
User → Enter Invite Code → [API: verify-invite-code]
   ↓
If invalid → Error: Invalid or Used Code
   ↓
If valid → Enter Basic Info → [API: start-registration]
   ↓
Send OTP → [API: send-otp]
   ↓
Enter OTP → [API: verify-otp]
   ↓
If correct → Set Password → [API: set-password]
   ↓
Create Employee + Update InviteCode
   ↓
Login → Dashboard (Based on permissions)
```
